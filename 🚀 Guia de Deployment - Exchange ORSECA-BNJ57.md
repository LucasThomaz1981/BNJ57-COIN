# üöÄ Guia de Deployment - Exchange ORSECA-BNJ57

## Vis√£o Geral

Este guia fornece instru√ß√µes detalhadas para fazer o deployment da Exchange ORSECA-BNJ57 em ambiente de produ√ß√£o. A arquitetura foi projetada para ser escal√°vel, segura e de f√°cil manuten√ß√£o.

## Pr√©-requisitos

### Infraestrutura Necess√°ria

- **Servidor Principal**: 8 CPU cores, 16GB RAM, 500GB SSD
- **Banco de Dados**: PostgreSQL 14+ ou MySQL 8+
- **Cache**: Redis 6+
- **Load Balancer**: Nginx ou HAProxy
- **SSL Certificate**: Let's Encrypt ou certificado comercial
- **Dom√≠nio**: exchange.orseca.org (ou similar)

### Depend√™ncias de Software

- **Backend**: Python 3.11+, Flask, SQLAlchemy
- **Frontend**: Node.js 18+, React 18+, Vite
- **Containeriza√ß√£o**: Docker 20+, Docker Compose
- **Monitoramento**: Prometheus, Grafana (opcional)

## Estrutura de Deployment

```
/opt/orseca-exchange/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ dist/
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îî‚îÄ‚îÄ ssl/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ init.sql
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ deploy.sh
    ‚îú‚îÄ‚îÄ backup.sh
    ‚îî‚îÄ‚îÄ update.sh
```

## Configura√ß√£o do Backend

### 1. Prepara√ß√£o do Ambiente

```bash
# Criar usu√°rio para a aplica√ß√£o
sudo useradd -m -s /bin/bash orseca-exchange
sudo usermod -aG docker orseca-exchange

# Criar diret√≥rios
sudo mkdir -p /opt/orseca-exchange
sudo chown -R orseca-exchange:orseca-exchange /opt/orseca-exchange

# Clonar reposit√≥rio
cd /opt/orseca-exchange
git clone https://github.com/orseca/bnj57-exchange.git .
```

### 2. Configura√ß√£o de Vari√°veis de Ambiente

```bash
# Criar arquivo .env
cat > /opt/orseca-exchange/.env << EOF
# Configura√ß√µes da Aplica√ß√£o
FLASK_ENV=production
SECRET_KEY=sua-chave-secreta-super-segura
JWT_SECRET_KEY=sua-chave-jwt-super-segura

# Banco de Dados
DATABASE_URL=postgresql://orseca_user:senha_segura@localhost:5432/orseca_exchange

# Redis
REDIS_URL=redis://localhost:6379/0

# APIs Externas
BLOCKCHAIN_RPC_URL=https://mainnet.infura.io/v3/seu-projeto-id
COINGECKO_API_KEY=sua-api-key-coingecko

# Configura√ß√µes de Email
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=noreply@orseca.org
SMTP_PASSWORD=senha-do-email

# Configura√ß√µes de Seguran√ßa
ALLOWED_HOSTS=exchange.orseca.org,www.exchange.orseca.org
CORS_ORIGINS=https://exchange.orseca.org

# Configura√ß√µes de Upload
MAX_CONTENT_LENGTH=16777216
UPLOAD_FOLDER=/opt/orseca-exchange/uploads
EOF
```

### 3. Configura√ß√£o do Docker Compose

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: orseca-backend
    restart: unless-stopped
    environment:
      - FLASK_ENV=production
    env_file:
      - .env
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      - database
      - redis
    networks:
      - orseca-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: orseca-frontend
    restart: unless-stopped
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
    networks:
      - orseca-network

  database:
    image: postgres:14
    container_name: orseca-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: orseca_exchange
      POSTGRES_USER: orseca_user
      POSTGRES_PASSWORD: senha_segura
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - orseca-network

  redis:
    image: redis:6-alpine
    container_name: orseca-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - orseca-network

  nginx:
    image: nginx:alpine
    container_name: orseca-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./frontend/dist:/usr/share/nginx/html
    depends_on:
      - backend
      - frontend
    networks:
      - orseca-network

volumes:
  postgres_data:
  redis_data:

networks:
  orseca-network:
    driver: bridge
```

## Configura√ß√£o do Frontend

### 1. Build de Produ√ß√£o

```bash
# Instalar depend√™ncias
cd /opt/orseca-exchange/frontend
npm install

# Configurar vari√°veis de ambiente
cat > .env.production << EOF
VITE_API_BASE_URL=https://api.exchange.orseca.org
VITE_WS_URL=wss://api.exchange.orseca.org/ws
VITE_ENVIRONMENT=production
VITE_SENTRY_DSN=sua-dsn-do-sentry
EOF

# Build de produ√ß√£o
npm run build
```

### 2. Dockerfile de Produ√ß√£o

```dockerfile
# frontend/Dockerfile.prod
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## Configura√ß√£o do Nginx

### 1. Configura√ß√£o Principal

```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Configura√ß√µes de seguran√ßa
    server_tokens off;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

    # Upstream para backend
    upstream backend {
        server backend:5000;
    }

    # Redirecionamento HTTP para HTTPS
    server {
        listen 80;
        server_name exchange.orseca.org www.exchange.orseca.org;
        return 301 https://$server_name$request_uri;
    }

    # Servidor HTTPS principal
    server {
        listen 443 ssl http2;
        server_name exchange.orseca.org www.exchange.orseca.org;

        # Configura√ß√µes SSL
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;

        # Frontend
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
            
            # Cache para assets est√°ticos
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # API Backend
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # WebSocket para dados em tempo real
        location /ws/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Endpoint de login com rate limiting mais restritivo
        location /api/auth/login {
            limit_req zone=login burst=5 nodelay;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

## Configura√ß√£o do Banco de Dados

### 1. Inicializa√ß√£o

```sql
-- database/init.sql
CREATE DATABASE orseca_exchange;
CREATE USER orseca_user WITH ENCRYPTED PASSWORD 'senha_segura';
GRANT ALL PRIVILEGES ON DATABASE orseca_exchange TO orseca_user;

-- Configura√ß√µes de performance
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
```

### 2. Backup Autom√°tico

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/opt/orseca-exchange/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="orseca_exchange"

# Criar diret√≥rio de backup
mkdir -p $BACKUP_DIR

# Backup do banco de dados
docker exec orseca-db pg_dump -U orseca_user $DB_NAME | gzip > $BACKUP_DIR/db_backup_$DATE.sql.gz

# Backup de arquivos de upload
tar -czf $BACKUP_DIR/uploads_backup_$DATE.tar.gz /opt/orseca-exchange/uploads/

# Manter apenas os √∫ltimos 30 backups
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "Backup conclu√≠do: $DATE"
```

## Scripts de Deployment

### 1. Script de Deploy

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "üöÄ Iniciando deployment da Exchange ORSECA..."

# Verificar se est√° executando como usu√°rio correto
if [ "$USER" != "orseca-exchange" ]; then
    echo "‚ùå Execute como usu√°rio orseca-exchange"
    exit 1
fi

# Navegar para diret√≥rio da aplica√ß√£o
cd /opt/orseca-exchange

# Fazer backup antes do deploy
echo "üì¶ Criando backup..."
./scripts/backup.sh

# Atualizar c√≥digo
echo "üì• Atualizando c√≥digo..."
git pull origin main

# Parar servi√ßos
echo "‚èπÔ∏è Parando servi√ßos..."
docker-compose -f docker-compose.prod.yml down

# Build das imagens
echo "üî® Construindo imagens..."
docker-compose -f docker-compose.prod.yml build

# Executar migra√ß√µes
echo "üóÑÔ∏è Executando migra√ß√µes..."
docker-compose -f docker-compose.prod.yml run --rm backend python -m flask db upgrade

# Iniciar servi√ßos
echo "‚ñ∂Ô∏è Iniciando servi√ßos..."
docker-compose -f docker-compose.prod.yml up -d

# Verificar sa√∫de dos servi√ßos
echo "üîç Verificando sa√∫de dos servi√ßos..."
sleep 30

if curl -f http://localhost/api/health > /dev/null 2>&1; then
    echo "‚úÖ Deployment conclu√≠do com sucesso!"
else
    echo "‚ùå Falha no deployment - verificar logs"
    docker-compose -f docker-compose.prod.yml logs
    exit 1
fi
```

### 2. Script de Monitoramento

```bash
#!/bin/bash
# scripts/monitor.sh

# Verificar status dos containers
echo "üìä Status dos Containers:"
docker-compose -f docker-compose.prod.yml ps

# Verificar uso de recursos
echo -e "\nüíæ Uso de Mem√≥ria:"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"

# Verificar logs de erro
echo -e "\nüö® √öltimos Erros:"
docker-compose -f docker-compose.prod.yml logs --tail=50 | grep -i error

# Verificar conectividade
echo -e "\nüåê Teste de Conectividade:"
curl -s -o /dev/null -w "API Status: %{http_code}\n" http://localhost/api/health
curl -s -o /dev/null -w "Frontend Status: %{http_code}\n" http://localhost/
```

## Configura√ß√£o de SSL

### 1. Certificado Let's Encrypt

```bash
# Instalar Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# Obter certificado
sudo certbot --nginx -d exchange.orseca.org -d www.exchange.orseca.org

# Configurar renova√ß√£o autom√°tica
sudo crontab -e
# Adicionar linha:
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. Configura√ß√£o Manual de SSL

```bash
# Criar diret√≥rio SSL
mkdir -p /opt/orseca-exchange/nginx/ssl

# Copiar certificados
cp /path/to/fullchain.pem /opt/orseca-exchange/nginx/ssl/
cp /path/to/privkey.pem /opt/orseca-exchange/nginx/ssl/

# Definir permiss√µes
chmod 600 /opt/orseca-exchange/nginx/ssl/*
chown root:root /opt/orseca-exchange/nginx/ssl/*
```

## Monitoramento e Logs

### 1. Configura√ß√£o de Logs

```yaml
# Adicionar ao docker-compose.prod.yml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 2. Monitoramento com Prometheus

```yaml
# monitoring/docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus
    container_name: orseca-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - orseca-network

  grafana:
    image: grafana/grafana
    container_name: orseca-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=senha_admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - orseca-network

volumes:
  prometheus_data:
  grafana_data:

networks:
  orseca-network:
    external: true
```

## Seguran√ßa

### 1. Firewall

```bash
# Configurar UFW
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 2. Fail2Ban

```bash
# Instalar Fail2Ban
sudo apt install fail2ban

# Configurar para Nginx
cat > /etc/fail2ban/jail.local << EOF
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
logpath = /var/log/nginx/error.log
maxretry = 10
bantime = 600
EOF

sudo systemctl restart fail2ban
```

## Manuten√ß√£o

### 1. Atualiza√ß√µes Regulares

```bash
# Criar cron job para atualiza√ß√µes
cat > /etc/cron.d/orseca-maintenance << EOF
# Backup di√°rio √†s 2:00 AM
0 2 * * * orseca-exchange /opt/orseca-exchange/scripts/backup.sh

# Limpeza de logs √†s 3:00 AM
0 3 * * * orseca-exchange docker system prune -f

# Verifica√ß√£o de sa√∫de a cada 5 minutos
*/5 * * * * orseca-exchange /opt/orseca-exchange/scripts/health-check.sh
EOF
```

### 2. Procedimentos de Emerg√™ncia

```bash
# Script de rollback
#!/bin/bash
# scripts/rollback.sh

echo "üîÑ Iniciando rollback..."

# Parar servi√ßos atuais
docker-compose -f docker-compose.prod.yml down

# Restaurar backup mais recente
LATEST_BACKUP=$(ls -t /opt/orseca-exchange/backups/db_backup_*.sql.gz | head -1)
gunzip -c $LATEST_BACKUP | docker exec -i orseca-db psql -U orseca_user orseca_exchange

# Voltar para commit anterior
git reset --hard HEAD~1

# Rebuild e restart
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d

echo "‚úÖ Rollback conclu√≠do"
```

## Checklist de Deployment

### Pr√©-Deployment
- [ ] Servidor configurado com recursos adequados
- [ ] Dom√≠nio configurado e DNS apontando para servidor
- [ ] Certificado SSL obtido e configurado
- [ ] Vari√°veis de ambiente configuradas
- [ ] Backup do ambiente atual (se aplic√°vel)

### Durante Deployment
- [ ] C√≥digo atualizado do reposit√≥rio
- [ ] Imagens Docker constru√≠das
- [ ] Migra√ß√µes de banco executadas
- [ ] Servi√ßos iniciados
- [ ] Testes de conectividade realizados

### P√≥s-Deployment
- [ ] Monitoramento configurado
- [ ] Logs verificados
- [ ] Performance testada
- [ ] Backup autom√°tico configurado
- [ ] Documenta√ß√£o atualizada

## Troubleshooting

### Problemas Comuns

1. **Container n√£o inicia**
   ```bash
   docker-compose logs [service_name]
   docker inspect [container_name]
   ```

2. **Erro de conex√£o com banco**
   ```bash
   docker exec -it orseca-db psql -U orseca_user orseca_exchange
   ```

3. **Problemas de SSL**
   ```bash
   openssl s_client -connect exchange.orseca.org:443
   ```

4. **Performance lenta**
   ```bash
   docker stats
   htop
   iotop
   ```

### Contatos de Suporte

- **T√©cnico**: tech@orseca.org
- **Emerg√™ncia**: +55 11 9999-9999
- **Documenta√ß√£o**: https://docs.exchange.orseca.org

---

*Este guia deve ser atualizado conforme a evolu√ß√£o da plataforma e mudan√ßas na infraestrutura.*

**Vers√£o**: 1.0  
**Data**: 22 de Julho de 2025  
**Respons√°vel**: Equipe DevOps ORSECA

